# Code Signature - AI Knowledge Base

## Basic Information

| Attribute | Value |
|-----------|-------|
| Repository Name | code_signature |
| Subsystem | base/security |
| Primary Language | C++ / Rust |
| Last Updated | 2026-01-31 |

## Directory Structure

```
code_signature/
├── interfaces/                    # Interface layer (API definitions)
│   └── inner_api/
│       ├── code_sign_utils/      # Core code signing APIs
│       ├── code_sign_attr_utils/ # Attribute setting APIs
│       ├── local_code_sign/      # Local signing APIs
│       ├── jit_code_sign/        # JIT code signing APIs
│       └── common/               # Shared types and utilities
├── services/                     # Service layer (implementations)
│   ├── local_code_sign/          # Local code signing service
│   └── key_enable/               # Certificate initialization service
├── utils/                        # Utility layer (helper functions)
├── test/                         # Test cases
│   ├── unittest/                 # Unit tests
│   └── fuzztest/                 # Fuzz tests
├── BUILD.gn                      # Main build configuration
├── code_signature.gni            # Build arguments and feature flags
├── bundle.json                   # Component metadata
└── README.md                     # Component documentation
```

### Key Directory Description

| Directory | Description |
|-----------|-------------|
| interfaces/inner_api/code_sign_utils/ | Core APIs for code signing enforcement (EnforceCodeSignForApp, EnableKeyInProfile) |
| interfaces/inner_api/local_code_sign/ | Local code signing APIs (InitLocalCertificate, SignLocalCode) |
| interfaces/inner_api/code_sign_attr_utils/ | Code attribute setting APIs (InitXpm, SetXpmOwnerId) |
| interfaces/inner_api/jit_code_sign/ | JIT code signing for ARMv8.3-A+ Pointer Authentication |
| services/local_code_sign/ | SystemAbility implementation for local signing service |
| services/key_enable/ | Certificate trust management (Rust + C++ FFI) |
| utils/ | Common utilities (ELF parsing, fs-verity, OpenSSL wrappers) |

---

## Repository Overview

### Introduction

The code signature component implements the code signing mechanism of OpenHarmony. It provides validity check and integrity protection for apps at runtime, preventing execution of malicious code on devices and malicious tampering of app code by attackers.

### Core Functions

- **Trusted Certificate Management**: Imports device certificate and local code signing certificate, validates certificate chains and trusted sources
- **Code Signing Enabling**: Provides user-mode APIs to enable code signing for apps or code files during installation
- **Local Code Signing**: Runs signing service on device and provides interfaces to sign local code (e.g., native code generated by AOT)
- **Code Attribute Setting**: Provides APIs for setting code owner ID and initializing XPM region
- **JIT Code Signing**: ARMv8.3-A Pointer Authentication (PAC) support for JIT-generated code

### Technology Stack

- **C++17**: Primary implementation language for services and interfaces
- **Rust**: Key enable service (certificate trust management)
- **C**: FFI layer between Rust and C++

### Main Dependencies

| Dependency | Purpose |
|------------|---------|
| HUKS | Universal key storage for certificates |
| SAMGR | System ability manager |
| OpenSSL | PKCS7 certificate parsing, signature verification |
| fs-verity-utils | File integrity verification |
| SELinux | Mandatory access control |
| elfio | ELF file parsing |
| HISYSEVENT | System event logging |
| HITRACE | Performance tracing |

---

## Build and Test

### Build Configuration

Feature flags in [code_signature.gni](code_signature.gni):

| Flag | Default | Description |
|------|---------|-------------|
| code_signature_support_openharmony_ca | true | Support OpenHarmony CA certificates |
| code_signature_support_oh_code_sign | false | Enable OH code signing |
| code_signature_enable_xpm_mode | 0 | XPM mode enablement (0=disabled) |
| code_signature_support_oh_release_app | false | Support release app signing |
| code_signature_support_app_allow_list | false | Enable app allow list |
| jit_code_sign_enable | auto | JIT signing (auto-enabled on arm64) |

### Build Commands

```bash
# Build component only
./build.sh --product-name rk3568 --build-target base/security/code_signature:code_signature

# Build tests
./build.sh --product-name rk3568 --build-target base/security/code_signature/test:testgroup --no-indep
```

Or use independent compilation

```bash
# Build component only
hb build code_signature -i

# Build tests
hb build code_signature -t
```

### Test Commands

```bash
# Build all tests
./build.sh --product-name rk3568 --build-target base/security/code_signature/test:testgroup  --no-indep

# Test binaries location: out/{product}/tests/unittest/code_signature/code_signature/
# Available unit tests:
#   - code_sign_utils_unittest
#   - local_code_sign_unittest
#   - code_sign_attr_utils_unittest
#   - jit_code_sign_unittest
#   - cert_chain_verifier_unittest
#   - local_code_sign_utils_unittest
#   - local_code_sign_utils_mock_unittest
#   - code_sign_utils_in_c_unittest
#   - enable_verity_ioctl_unittest
#   - sign_and_enforce_unittest
#   - multi_thread_local_sign_unittest
#   - key_enable_utils_unittest (when code_signature_support_oh_code_sign=true)
#   - rust_key_enable_unittest (when not using clang coverage)

# Run fuzz tests (requires HKP tool)
# Available fuzzers:
#   - InitLocalCertificateStubFuzzTest
#   - SignLocalCodeStubFuzzTest
#   - InitLocalCertificateFuzzTest
#   - SignLocalCodeFuzzTest
```

### Running Tests on Device

```bash
# Push tests to device
hdc shell mkdir -p /data/test
hdc file send out/rk3568/tests/unittest/code_signature/code_signature/* /data/test/

# Run specific test on device
hdc shell /data/test/code_sign_utils_unittest

# Run all tests on device
hdc shell "cd /data/test && for test in *_unittest; do ./\$test; done"
```

### Build Artifacts

| Artifact Type | Location |
|---------------|----------|
| Libraries and Binaries | out/{product}/security/code_signature/ |
| Test binaries | out/{product}/tests/unittest/code_signature/ |

---

### Coding style
- [Coding style guide](../../../docs/en/contribute/OpenHarmony-cpp-coding-style-guide.md)
- [License header](../../../docs/en/contribute/license-and-copyright-specifications.md)

## API Reference

### Core Code Signing APIs

Located in [interfaces/inner_api/code_sign_utils/include/code_sign_utils.h](interfaces/inner_api/code_sign_utils/include/code_sign_utils.h):

```cpp
// Enforce code signing for HAP packages
int32_t EnforceCodeSignForApp(const EntryMap &entryPath, const std::string &signatureFile);

// Enforce code signing for files
int32_t EnforceCodeSignForFile(const std::string &path, const ByteBuffer &signature);

// Parse owner ID from signature
int ParseOwnerIdFromSignature(const ByteBuffer &sigbuffer, std::string &ownerID);

// Trust developer certificate
int32_t EnableKeyInProfile(const std::string &bundleName, const ByteBuffer &profileBuffer);

// Revoke trusted certificate
int32_t RemoveKeyInProfile(const std::string &bundleName);
```

### Local Code Signing APIs

Located in [interfaces/inner_api/local_code_sign/include/local_code_sign_kit.h](interfaces/inner_api/local_code_sign/include/local_code_sign_kit.h):

```cpp
// Initialize local code signing certificate
int32_t InitLocalCertificate(ByteBuffer &cert);

// Sign local code file
int32_t SignLocalCode(const std::string &filePath, ByteBuffer &signature);

// Sign with owner ID
int32_t SignLocalCode(const std::string &ownerID, const std::string &filePath, ByteBuffer &signature);
```

### Code Attribute APIs

Located in [interfaces/inner_api/code_sign_attr_utils/include/code_sign_attr_utils.h](interfaces/inner_api/code_sign_attr_utils/include/code_sign_attr_utils.h):

```cpp
// Initialize XPM resources
int InitXpm(int enableJitFort, uint32_t idType, const char *ownerId,
            const char *apiTargetVersionStr, const char *appSignType);

// Set owner ID for XPM
int SetXpmOwnerId(uint32_t idType, const char *ownerId);
```

### JIT Code Signing APIs

Located in [interfaces/inner_api/jit_code_sign/include/jit_code_signer.h](interfaces/inner_api/jit_code_sign/include/jit_code_signer.h):

```cpp
// Sign JIT-generated code buffer
int32_t SignJitCode(uint64_t codeAddr, size_t codeSize, ByteBuffer &signature);

// Verify JIT code signature
bool VerifyJitCode(uint64_t codeAddr, size_t codeSize, const ByteBuffer &signature);
```

---

## Architecture Design

### Component Layers

```
┌─────────────────────────────────────────────────────────┐
│                   Application Layer                      │
│              (HAP Installation, AOT Compiler)            │
└─────────────────────────────────────────────────────────┘
                           │
┌─────────────────────────────────────────────────────────┐
│                    Interface Layer                       │
│  code_sign_utils | local_code_sign | code_sign_attr_utils │
└─────────────────────────────────────────────────────────┘
                           │
┌─────────────────────────────────────────────────────────┐
│                     Service Layer                        │
│        LocalCodeSignService | KeyEnableService           │
└─────────────────────────────────────────────────────────┘
                           │
┌─────────────────────────────────────────────────────────┐
│                    Utility Layer                         │
│  ELF Parser | fs-verity | OpenSSL | Certificate Utils    │
└─────────────────────────────────────────────────────────┘
                           │
┌─────────────────────────────────────────────────────────┐
│                   Kernel Layer                           │
│              fs-verity | XPM | PAC                       │
└─────────────────────────────────────────────────────────┘
```

### Key Data Structures

- **CodeSignBlock**: Metadata block attached to signed files
- **XpmConfig**: XPM region configuration (owner ID, JIT fort settings)
- **FileType**: Enum for file signing scope (FILE_ALL, FILE_SELF, FILE_ENTRY_ONLY)
- **FileOwneridType**: Owner ID types (SYSTEM, APP, DEBUG)

### IPC Communication

- LocalCodeSignService registered as SystemAbility (SA ID: 3507)
- IPC stub: LocalCodeSignStub
- Configuration: [sa_profile/3507.json](services/local_code_sign/sa_profile/3507.json)

---

## Module Workflows

### code_sign_utils Module

**Location**: [interfaces/inner_api/code_sign_utils/src/](interfaces/inner_api/code_sign_utils/src/)

**Purpose**: Enforce code signing on HAP packages and individual files during installation.

---

### local_code_sign_service Module

**Location**: [services/local_code_sign/src/](services/local_code_sign/src/)

**Purpose**: SystemAbility (SA ID: 3507) for on-device local code signing (e.g., AOT-generated code).

---

### key_enable Module (Rust)

**Location**: [services/key_enable/src/](services/key_enable/src/)

**Purpose**: Certificate trust management - load device certs, manage kernel keyring, handle developer certs.

---

### jit_code_sign Module

**Location**: [interfaces/inner_api/jit_code_sign/src/](interfaces/inner_api/jit_code_sign/src/)

**Purpose**: ARMv8.3-A Pointer Authentication (PAC) for JIT-generated code integrity.

---

### code_sign_attr_utils Module

**Location**: [interfaces/inner_api/code_sign_attr_utils/src/](interfaces/inner_api/code_sign_attr_utils/src/)

**Purpose**: Configure code attributes (XPM region, owner ID) for memory access control.

---

## Development Guidelines

### Adding New Code Signing APIs

1. Define API in appropriate interface header (code_sign_utils.h or local_code_sign_kit.h)
2. Implement in corresponding service layer
3. Add IPC stub methods if service interaction needed
4. Write unit tests in test/unittest/
5. Update inner_kits in bundle.json if exporting

### Modifying Build Configuration

Edit [code_signature.gni](code_signature.gni):

```gni
declare_args() {
  # Add new feature flag
  code_signature_new_feature = false
}
```

Use conditionally in BUILD.gn:

```gni
if (code_signature_new_feature) {
  sources += [ "new_feature.cpp" ]
}
```

### Adding Test Cases

Unit tests go in [test/unittest/](test/unittest/):
- Use HWTEST_F framework for OpenHarmony C++ tests
- Mock external dependencies (HUKS, OpenSSL) where appropriate
- Target 75%+ code coverage

---

## Error Code Reference

Error codes defined in [interfaces/inner_api/common/include/errcode.h](interfaces/inner_api/common/include/errcode.h):

---

## Related Repositories

- [developtools_hapsigner](https://gitcode.com/openharmony/developtools_hapsigner) - HAP signing tool
- [kernel_linux_common_modules](https://gitcode.com/openharmony/kernel_linux_common_modules) - fs-verity kernel support
- [third_party_fsverity-utils](https://gitcode.com/openharmony/third_party_fsverity-utils) - fs-verity userspace utilities

---

## Version History

| Version | Date | Changes | Maintainer |
|---------|------|---------|------------|
| v1.3 | 2026-01-31 | Add error code reference, consolidate Technology Stack section | Claude |
| v1.2 | 2026-01-31 | Simplify module workflows, remove Common Pitfalls | Claude |
| v1.1 | 2026-01-31 | Add module workflows, fix test commands | Claude |
| v1.0 | 2026-01-31 | Initial CLAUDE.md creation | Claude |
